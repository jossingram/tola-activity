{% extends "base.html" %}
{% block bread_crumb %}
<ol class="breadcrumb">
  <li><a href="/activitydb/dashboard/0/">Program Dashboards</a></li>
  <li><a href="/activitydb/report/">Activity Report</a></li>
  <li class="active">Report</li>
</ol>

{% endblock bread_crumb %}
{% load render_table from django_tables2 %}

{% block page_title %}Activity Report{% endblock %}

{% block content %}
<ul class="nav nav-tabs">
  <li role="presentation"><a href="/activitydb/projectproposal_detail/{{ id }}/">Proposal</a></li>
  <li role="presentation"><a href="/activitydb/projectagreement_detail/{{ id }}/">Agreement</a></li>
  <li role="presentation"><a href="/activitydb/projectcomplete_detail/{{ id }}/">Complete</a></li>
  <li role="presentation" class="active"><a href="/activitydb/community_report/{{ id }}/">Communities</a></li>
</ul>
<h3>{{ proposal.project_name }}</h3>
<style>
    #map { height: 480px; }
</style>

<p><b>{{ country.country }} Communities</b></p>
<div id="map"></div>

<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
<link rel="borders" type="application/json" href="{{ STATIC_URL }}js/world_borders.geojson">

<script type="text/javascript">
    var country = "{{ country.latitude }},{{ country.longitude }}";

    var osmLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>',
        thunLink = '<a href="http://thunderforest.com/">Thunderforest</a>';

    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        osmAttrib = '&copy; ' + osmLink + ' Contributors',
        osmHumURL = "http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",
        osmHumAttrib = "Â© OpenStreetMap Contributors. Tiles courtesy of Humanitarian OpenStreetMap Team",
        landUrl = 'http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png',
        thunAttrib = '&copy; '+osmLink+' Contributors & '+thunLink;
    var osmMap = L.tileLayer(osmUrl, {attribution: osmAttrib}),
        landMap = L.tileLayer(landUrl, {attribution: thunAttrib}),
        osmHumMap = L.tileLayer(osmHumURL, {attribution: osmHumAttrib});

    var baseLayers = {
			"OSM Mapnik": osmMap,
            "OSM Humanitarian": osmHumMap,
			"Landscape": landMap
		};

    var map = L.map('map', {
            layers: [osmMap] // only add one!
        }).setView([{{ country.latitude }},{{ country.longitude }}], 5);

    L.control.layers(baseLayers).addTo(map);
    // Load map with geojson fil that contains borders
    $.getJSON($('link[rel="borders"]').attr("href"), function(data) {

        function style(feature) {
            return {
            fillColor: "#E3E3E3",
            weight: 1,
            opacity: 0.4,
            color: 'white',
            fillOpacity: 0.3
            };
        }

        var geojson = L.geoJson(data, {
        onEachFeature: onEachFeature,
        style : style
        }).addTo(map);

        function onEachFeature(feature, layer){
            layer.on({
            click : onCountryClick,
            mouseover : onCountryHighLight,
            mouseout : onCountryMouseOut
            });
        }

        /**
        * Callback for mouse out of the country border. Will take care of the ui aspects, and will call
        * other callbacks after done.
        * @param e the event
        */
        function onCountryMouseOut(e){
            geojson.resetStyle(e.target);
            // $("#countryHighlighted").text("No selection");

            var countryName = e.target.feature.properties.NAME;
            var countryCode = e.target.feature.properties.iso_a2;
            //callback when mouse exits a country polygon goes here, for additional actions
        }

        /**
        * Callback for when a country is clicked. Will take care of the ui aspects, and it will call
        * other callbacks when done
        * @param e
        */
        function onCountryClick(e){
        //callback for clicking inside a polygon
            geojson.bindPopup(e.target.feature.properties.NAME);
        }

        /**
        * Callback for when a country is highlighted. Will take care of the ui aspects, and it will call
        * other callbacks after done.
        * @param e
        */
        function onCountryHighLight(e){
                var layer = e.target;

                layer.setStyle({
                weight: 2,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
                });

            if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
            }

            var countryName = e.target.feature.properties.name;
            var countryCode = e.target.feature.properties.iso_a2;
            //callback when mouse enters a country polygon goes here, for additional actions
         }

     });


    {% for item in getCommunity %}
        L.marker([{{ item.latitude }}, {{ item.longitude }}]).addTo(map).bindPopup("" + "<b>{{ item.country }}</b> <a href='/activitydb/community_update/{{ item.id }}'>{{ item.name }}</a> <br/>Province: {{ incident.province }} <br/>District: {{ item.district }} <br/> Village: {{ item.village }} <br/> Community: {{ item.name }} <br/> ").openPopup();
    {%   endfor %}


</script>

<ul class="list-group">
{% for item in getCommunity %}
    <li class="list-group-item"><b>{{ item.create_date|date }} - {{ item.name }}</b>
    <div class="btn-group align-right" role="group" aria-label="...">
        <a href="/activitydb/community_update/{{ item.id }}" class="btn btn-xs btn-warning">Update Community</a>
    </div>
    </li>
{% empty %}
    <li class="list-group-item">No communities yet.</li>
{% endfor %}
</ul>
{% endblock content %}