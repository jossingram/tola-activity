{% extends "base.html" %}
{% block bread_crumb %}
<ol class="breadcrumb">
  <li><a href="/activitydb/dashboard/0/">Program Dashboards</a></li>
  {%  if project_proposal_id %}
    <li><a href="/activitydb/dashboard/project/{{ project_proposal_id }}/">Project Dashboards</a></li>
  {% endif %}
  <li class="active">Communites</li>
</ol>
{% endblock %}
{% load group_tag %}
{% block page_title %}Community List{% endblock %}

{% block content %}
<div>

    <a href="/activitydb/community_add" class="btn btn-large btn-success">New Community</a> &nbsp;
    <a href="/activitydb/community_import" class="btn btn-large btn-info">Import Community</a>

<hr/>
</div>
<style>
    #map { height: 480px; }
</style>

<form action="#" method="post">
<p>Zoom to Region: 	<select id="region" onchange="ZoomToCountry(this.value);">
				<option value="1">All Regions</option>
				<option>East & Southern Africa</option>
				<option>Central & South Asia</option>
				<option>West & Central Africa</option>
				<option>East Asia</option>
				<option>Latin America, Caribbean, Balkans, Caucasus</option>
				<option>Middle East</option>
			</select></p>
</form>
<p><b>Communities</b></p>
<div id="map"></div>

<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

<link rel="borders" type="application/json" href="{{ STATIC_URL }}js/world_borders.geojson">

<script type="text/javascript">

    var osmLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>',
        thunLink = '<a href="http://thunderforest.com/">Thunderforest</a>';

    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        osmAttrib = '&copy; ' + osmLink + ' Contributors',
        osmHumURL = "http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",
        osmHumAttrib = "Â© OpenStreetMap Contributors. Tiles courtesy of Humanitarian OpenStreetMap Team",
        landUrl = 'http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png',
        thunAttrib = '&copy; '+osmLink+' Contributors & '+thunLink;
    var osmMap = L.tileLayer(osmUrl, {attribution: osmAttrib}),
        landMap = L.tileLayer(landUrl, {attribution: thunAttrib}),
        osmHumMap = L.tileLayer(osmHumURL, {attribution: osmHumAttrib});

    var baseLayers = {
			"OSM Mapnik": osmMap,
            "OSM Humanitarian": osmHumMap,
			"Landscape": landMap
		};

    //Init map with default zoom and coordinates of logged in users country
    var map = L.map('map', {
            layers: [osmMap] // only add one!
        }).setView([{{ country.latitude }},{{ country.longitude }}], 5);

    L.control.layers(baseLayers).addTo(map);
    // Load map with geojson file that contains borders
    $.getJSON($('link[rel="borders"]').attr("href"), function(data) {

        /**
         * Set the style for each feature(country) to be light grey by default
         * @param feature (from getJson file)
        */
        function style(feature) {
            return {
            fillColor: "#E3E3E3",
            weight: 1,
            opacity: 0.4,
            color: 'white',
            fillOpacity: 0.3
            };
        }

        var geojson = L.geoJson(data, {
        onEachFeature: onEachFeature,
        style : style
        }).addTo(map);

        /**
         * Loops over each feature and creates call back function for events
         * Also highlights the default country based on user login
         * @param feature (from getJson file)
         * @param layer (from geoJson file)
        */
        function onEachFeature(feature, layer){
             if (feature.properties.NAME == "{{ country.country }}") {
                highlightDefault(feature, layer);
             }

            layer.on({
            click : onCountryClick,
            mouseover : onCountryHighLight,
            mouseout : onCountryMouseOut,
            });
        }

        /**
        * Callback for mouse out of the country border. Will take care of the ui aspects, and will call
        * other callbacks after done.  If it's the default highlighted country leave it alone.
        * @param e the event
        */
        function onCountryMouseOut(e){
            if (e.target.feature.properties.NAME != "{{ country.country }}") {
                geojson.resetStyle(e.target);
            }
            // $("#countryHighlighted").text("No selection");

            var countryName = e.target.feature.properties.NAME;
            var countryCode = e.target.feature.properties.iso_a2;
            //callback when mouse exits a country polygon goes here, for additional actions
        }

        /**
        * Callback for when a country is clicked.  Pop-up the country name
        * @param e
        */
        function onCountryClick(e){
        //callback for clicking inside a polygon
            geojson.bindPopup(e.target.feature.properties.NAME);
        }

        /**
        * Callback for when a country is highlighted. Will take care of the ui aspects, and it will call
        * other callbacks after done. If it's the default highlighted country leave it alone.
        * @param e
        */
        function onCountryHighLight(e){

            if (e.target.feature.properties.NAME != "{{ country.country }}") {
                var layer = e.target;

                layer.setStyle({
                    weight: 2,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }

                var countryName = e.target.feature.properties.name;
                var countryCode = e.target.feature.properties.ISO2;
            }
            //callback when mouse enters a country polygon goes here, for additional actions
         }


        /**
        * Callback for hilighting the logged in users selected country
        * @param feature
        * @param layer
        */
        function highlightDefault(feature,layer){
                layer.setStyle({
                weight: 2,
                color: 'blue',
                dashArray: '',
                fillOpacity: 0.6,
                borderColor: 'blue'
                });
            var countryName = feature.properties.NAME;
            var countryCode = feature.properties.ISO2;

            //callback when mouse enters a country polygon goes here, for additional actions
         }


     });


    {% for item in getCommunity %}
        L.marker([{{ item.latitude }}, {{ item.longitude }}]).addTo(map).bindPopup("" + "<b>{{ item.country }}</b> <a href='/activitydb/community_update/{{ item.id }}'>{{ item.name }}</a> <br/>Province: {{ incident.province }} <br/>District: {{ item.district }} <br/> Village: {{ item.village }} <br/> Community: {{ item.name }} <br/> ").openPopup();
    {%   endfor %}


    function ZoomToCountry(region){
        if(region == "Latin America, Caribbean, Balkans, Caucasus"){
            map.setView([9,-60], 4);
        }else if(region == "East Asia"){
            map.setView([30,96], 4);
        }else if(region == "Central & South Asia"){
            map.setView([30,80], 4);
        }else if(region == "East & Southern Africa"){
            map.setView([10,10], 4);
        }else if(region == "West & Central Africa"){
            map.setView([10,10], 4);
        }else if(region == "Latin America, Caribbean, Balkans, Caucasus"){
            map.setView([30,20], 4);
        }else if(region == "Middle East"){
            map.setView([30,20], 4);
        }else if(region == "1"){
            map.setView([10,-10], 2);
        };
    }
</script>

<ul class="list-group">
{% for item in getCommunity %}
    <li class="list-group-item"><b>{{ item.create_date|date }} - {{ item.name }}</b>
    <div class="btn-group align-right" role="group" aria-label="...">
        <a href="/activitydb/community_update/{{ item.id }}" class="btn btn-xs btn-warning">Update Community</a>
        {% if request.user|has_group:"Editor" %}
            <a href="/activitydb/community_delete/{{ item.id }}" class="btn btn-xs btn-danger">Delete Community</a>
        {% endif %}
    </div>
    </li>
{% empty %}
    <li class="list-group-item">No communities yet.</li>
{% endfor %}
</ul>
{% endblock content %}